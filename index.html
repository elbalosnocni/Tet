h3>ğŸ† Báº£ng xáº¿p háº¡ng</h3>
<div id="ranking"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
apiKey: "AIzaSyAChGYSzBmFDm5QV0y2KvYqAZlt144zZxg",
authDomain: "tet-gia-toc-ho-truong.firebaseapp.com",
projectId: "tet-gia-toc-ho-truong",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const spinSound = document.getElementById("spinSound");
const winSound = document.getElementById("winSound");

const prizes=[
{text:"500k",value:500000},
{text:"200k",value:200000},
{text:"100k",value:100000},
{text:"50k",value:50000},
{text:"20k",value:20000},
{text:"ChÃºc may máº¯n",value:0}
];

const totalBudget=1000000;
const gameRef=db.collection("game").doc("main");
const wheel=document.getElementById("wheel");

let currentRotation=0;
const resetPassword="vtc";
let fullTriggered=false;

/* ===== Váº¼ CHá»® ===== */
window.onload=function(){
const radius=wheel.offsetWidth/2;
const textRadius=radius*0.55;

prizes.forEach((p,i)=>{
const angle=i*60+30;

const label=document.createElement("div");
label.style.position="absolute";
label.style.left="50%";
label.style.top="50%";
label.style.width="100px";
label.style.marginLeft="-50px";
label.style.marginTop="-12px";
label.style.textAlign="center";
label.style.fontWeight="bold";
label.style.fontSize="15px";
label.style.pointerEvents="none";
label.style.color="#b30000";

if(p.value==500000){
label.style.fontSize="20px";
label.style.fontWeight="900";
label.style.textShadow="2px 2px 0 gold";
}

label.style.transform=
`rotate(${angle}deg) translateY(-${textRadius}px) rotate(-${angle}deg)`;

label.innerText=p.text;
wheel.appendChild(label);
});
};

/* ===== INIT ===== */
async function init(){
const snap=await gameRef.get();
if(!snap.exists){
await gameRef.set({
budget:totalBudget,
players:{},
specialCount:0
});
}
}
init();

/* ===== REALTIME ===== */
gameRef.onSnapshot((doc)=>{
if(!doc.exists) return;
const data=doc.data();

const playerCount=Object.keys(data.players).length;
const spinBtn=document.getElementById("spinBtn");

if(playerCount>=10){
document.getElementById("qrPanel").style.display="none";
document.getElementById("fullNotice").style.display="block";
spinBtn.disabled=true;
spinBtn.innerText="ÄÃƒ Äá»¦ 10 NGÆ¯á»œI";
}else{
document.getElementById("qrPanel").style.display="block";
document.getElementById("fullNotice").style.display="none";
spinBtn.disabled=false;
spinBtn.innerText="QUAY NGAY";
}

document.getElementById("budget").innerText=
data.budget.toLocaleString();

let rankHTML="";
Object.entries(data.players)
.sort((a,b)=>b[1]-a[1])
.forEach(([name,value])=>{
rankHTML+=`<div>${name}: ${value.toLocaleString()} Ä‘</div>`;
});
document.getElementById("ranking").innerHTML=rankHTML;
});

/* ===== SPIN ===== */
async function spin(){

spinSound.currentTime=0;
spinSound.play();

const btn=document.getElementById("spinBtn");
btn.disabled=true;

const name=document.getElementById("name").value.trim();
if(!name){
btn.disabled=false;
return alert("Nháº­p tÃªn!");
}

try{
await db.runTransaction(async(transaction)=>{
const snap=await transaction.get(gameRef);
const data=snap.data();

if(Object.keys(data.players).length>=10)
throw "Äá»§ 10 ngÆ°á»i rá»“i!";

if(data.players[name]!==undefined)
throw "TÃªn Ä‘Ã£ quay!";

let available=prizes.filter(p=>{
if(p.value>data.budget) return false;
if(p.value==500000 && data.specialCount>=1) return false;
return true;
});

if(available.length==0)
throw "Háº¿t ngÃ¢n sÃ¡ch!";

let prize=available[Math.floor(Math.random()*available.length)];
let index=prizes.findIndex(p=>p.value==prize.value);

const segmentAngle = 360 / prizes.length;
const targetAngle = index * segmentAngle + segmentAngle / 2;

// bÃ¹ láº¡i gÃ³c -90deg ban Ä‘áº§u
const finalAngle = 360 - targetAngle + 90;

const rotation = 3600 + (360 - targetAngle);


currentRotation+=rotation;
wheel.style.transform=`rotate(${currentRotation}deg)`;

let newPlayers={...data.players};
newPlayers[name]=prize.value;

transaction.update(gameRef,{
players:newPlayers,
budget:data.budget-prize.value,
specialCount:prize.value==500000
? data.specialCount+1
: data.specialCount
});

setTimeout(()=>{
if(prize.value==500000){
winSound.play();
wheel.style.animation="zoomWin 0.6s";
setTimeout(()=>wheel.style.animation="",600);
launchFireworks();
alert("ğŸ‰ CHÃšC Má»ªNG "+name+" TRÃšNG 500K ğŸ‰");
}else{
alert(name+" trÃºng "+prize.text);
}
},4000);

});
}catch(err){
alert(err);
}

setTimeout(()=>btn.disabled=false,4000);
}

/* ===== RESET ===== */
async function resetGame(){
const pass=prompt("Nháº­p máº­t kháº©u reset:");
if(pass!==resetPassword){
alert("Sai máº­t kháº©u!");
return;
}

await gameRef.set({
budget:totalBudget,
players:{},
specialCount:0
});

currentRotation=-90;
wheel.style.transform="rotate(-90deg)";
fullTriggered=false;

alert("ÄÃ£ reset game!");
}

/* ===== FIREWORK ===== */
function launchFireworks(){
const duration=4000;
const end=Date.now()+duration;
const interval=setInterval(function(){
confetti({
particleCount:100,
spread:160,
origin:{x:Math.random(),y:Math.random()-0.2}
});
if(Date.now()>end){
clearInterval(interval);
}
},250);
}

/* ===== QR ===== */
new QRCode(document.getElementById("qr"),window.location.href);
</script>

</body>
</html>
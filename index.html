<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HÃI Lá»˜C Äáº¦U XUÃ‚N 2026</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
body{
margin:0;
font-family:Arial, sans-serif;
text-align:center;
background:linear-gradient(135deg,#a8edea,#fed6e3);
}

.panel{
background:white;
padding:15px;
border-radius:15px;
max-width:600px;
margin:15px auto;
box-shadow:0 0 15px rgba(0,0,0,0.1);
}

button{
padding:10px 20px;
font-size:18px;
border:none;
border-radius:10px;
background:#00b894;
color:white;
cursor:pointer;
margin:5px;
}

#wheel{
  width:320px;
  height:320px;
  margin:20px auto;
  border-radius:50%;
  border:10px solid #f1c40f;
  position:relative;
  transition: transform 4s cubic-bezier(.25,1,.5,1);
  background:conic-gradient(
    #ffeaa7 0deg 60deg,
    #fab1a0 60deg 120deg,
    #ffeaa7 120deg 180deg,
    #fab1a0 180deg 240deg,
    #ffeaa7 240deg 300deg,
    #fab1a0 300deg 360deg
  );
  transform: rotate(0deg);
}

.pointer{
position:absolute;
top:-15px;
left:50%;
transform:translateX(-50%);
font-size:28px;
}
</style>
</head>
<body>

<h1>ğŸ§§ HÃI Lá»˜C Äáº¦U XUÃ‚N 2026ğŸ§§</h1>

<div class="panel">
ğŸ’° NgÃ¢n sÃ¡ch cÃ²n: <b id="budget">3.000.000</b> Ä‘
<div id="qr"></div>
</div>

<input type="text" id="name" placeholder="Nháº­p tÃªn"><br>
<button id="spinBtn" onclick="spin()">QUAY NGAY</button>
<button onclick="resetGame()">RESET</button>

<div style="position:relative;">
<div id="wheel"></div>
<div class="pointer">ğŸ”»</div>
</div>

<div class="panel">
<h3>ğŸ† Báº£ng xáº¿p háº¡ng</h3>
<div id="ranking"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
apiKey: "AIzaSyAChGYSzBmFDm5QV0y2KvYqAZlt144zZxg",
authDomain: "tet-gia-toc-ho-truong.firebaseapp.com",
projectId: "tet-gia-toc-ho-truong",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const prizes=[
{text:"500k",value:500000},
{text:"200k",value:200000},
{text:"100k",value:100000},
{text:"50k",value:50000},
{text:"20k",value:20000},
{text:"ChÃºc may máº¯n",value:0}
];

const totalBudget=3000000;
const gameRef=db.collection("game").doc("main");
const wheel=document.getElementById("wheel");

let currentRotation=0;
const resetPassword="vtc";

/* ===== Váº¼ CHá»® ===== */
window.onload=function(){
const radius=wheel.offsetWidth/2;
const textRadius=radius*0.55;

prizes.forEach((p,i)=>{
const angle=i*60+30;

const label=document.createElement("div");
label.style.position="absolute";
label.style.left="50%";
label.style.top="50%";
label.style.width="100px";
label.style.marginLeft="-50px";
label.style.marginTop="-12px";
label.style.textAlign="center";
label.style.fontWeight="bold";
label.style.fontSize="15px";
label.style.pointerEvents="none";
label.style.color="#b30000";

label.style.transform=
`rotate(${angle}deg) translateY(-${textRadius}px) rotate(-${angle}deg)`;

label.innerText=p.text;
wheel.appendChild(label);
});
};

/* ===== INIT ===== */
async function init(){
const snap=await gameRef.get();
if(!snap.exists){
await gameRef.set({
  budget: totalBudget,
  players: {},
  prizeCount:{
    500000:0,
    200000:0,
    100000:0
  }
});
}
}
init();

/* ===== REALTIME ===== */
gameRef.onSnapshot((doc)=>{
if(!doc.exists) return;
const data=doc.data();

document.getElementById("budget").innerText=
data.budget.toLocaleString();

let rankHTML="";
Object.entries(data.players)
.sort((a,b)=>b[1]-a[1])
.forEach(([name,value])=>{
rankHTML+=`<div>${name}: ${value.toLocaleString()} Ä‘</div>`;
});
document.getElementById("ranking").innerHTML=rankHTML;
});

/* ===== SPIN ===== */
async function spin(){

const btn=document.getElementById("spinBtn");
btn.disabled=true;

const name=document.getElementById("name").value.trim();
if(!name){
btn.disabled=false;
return alert("Nháº­p tÃªn!");
}

try{
await db.runTransaction(async(transaction)=>{
const snap=await transaction.get(gameRef);
const data=snap.data();

if(data.players[name]!==undefined)
throw "TÃªn Ä‘Ã£ quay!";

let available=prizes.filter(p=>{
if(p.value>data.budget) return false;
if(
 (p.value==500000 || p.value==200000 || p.value==100000)
 && data.prizeCount?.[p.value]>=1
) return false;
return true;
});

if(available.length==0)
throw "Háº¿t ngÃ¢n sÃ¡ch!";

let prize=available[Math.floor(Math.random()*available.length)];
let index=prizes.findIndex(p=>p.value==prize.value);

const segmentAngle = 360 / prizes.length;

// GÃ³c giá»¯a cá»§a Ã´ trÃºng (theo há»‡ conic-gradient)
const segmentCenter = index * segmentAngle + segmentAngle / 2;

// MÅ©i tÃªn Ä‘ang á»Ÿ vá»‹ trÃ­ 12h = 270 Ä‘á»™
const pointerAngle = 270;

// GÃ³c cáº§n quay Ä‘á»ƒ Ã´ Ä‘Ã³ náº±m Ä‘Ãºng mÅ©i tÃªn
let rotationNeeded = pointerAngle - segmentCenter;

// Chuáº©n hÃ³a vá» 0â€“360
rotationNeeded = (rotationNeeded + 360) % 360;

// ThÃªm nhiá»u vÃ²ng quay cho Ä‘áº¹p
const extraSpins = 360 * 8;

// GÃ³c cuá»‘i cÃ¹ng tuyá»‡t Ä‘á»‘i
currentRotation = currentRotation + extraSpins + rotationNeeded;

currentRotation = 0;
wheel.style.transform = "rotate(0deg)";

let newPlayers={...data.players};
newPlayers[name]=prize.value;

let newPrizeCount=data.prizeCount || {
500000:0,200000:0,100000:0
};

if(prize.value==500000 || prize.value==200000 || prize.value==100000){
newPrizeCount[prize.value]+=1;
}

transaction.update(gameRef,{
players:newPlayers,
budget:data.budget-prize.value,
prizeCount:newPrizeCount
});

setTimeout(()=>{
alert(name+" trÃºng "+prize.text);
},4000);

});
}catch(err){
alert(err);
}

setTimeout(()=>btn.disabled=false,4000);
}

/* ===== RESET ===== */
async function resetGame(){
const pass=prompt("Nháº­p máº­t kháº©u reset:");
if(pass!==resetPassword){
alert("Sai máº­t kháº©u!");
return;
}

await gameRef.set({
budget:totalBudget,
players:{},
prizeCount:{
500000:0,
200000:0,
100000:0
}
});

currentRotation=-90;
wheel.style.transform="rotate(-90deg)";
alert("ÄÃ£ reset game!");
}

/* ===== QR ===== */
new QRCode(document.getElementById("qr"),window.location.href);
</script>

</body>
</html>

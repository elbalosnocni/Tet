<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Lucky Wheel</title>
<style>
body{
  text-align:center;
  font-family:sans-serif;
  background:#111;
  color:#fff;
}

canvas{
  margin-top:20px;
}

button{
  margin-top:20px;
  padding:12px 30px;
  font-size:18px;
  background:#f1c40f;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}

button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}
#stats{
  margin-top:30px;
  background:#222;
  padding:20px;
  width:300px;
  margin-left:auto;
  margin-right:auto;
  border-radius:10px;
  text-align:left;
}  
</style>
</head>
<body>

<h2>üé∞ V√≤ng quay may m·∫Øn</h2>
<canvas id="wheel" width="400" height="400"></canvas>
<br>
<button id="spinBtn">QUAY</button>

<div id="stats"></div>
  
<script>
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const spinBtn = document.getElementById("spinBtn");
const statsDiv = document.getElementById("stats");  

const prizes = ["500k","50k","20k","100k","10k","200k"];
const colors = ["#f39c12","#e74c3c"];

const centerX = 200;
const centerY = 200;
const radius = 180;

let currentAngle = 0;
let spinning = false;
let max500kWins = 1;   // gi·ªõi h·∫°n
//let current500kWins = 0;  

// ===== Load d·ªØ li·ªáu t·ª´ localStorage =====
let stats = JSON.parse(localStorage.getItem("wheelStats")) || {
  totalSpins:0,
  wins:{}
};

prizes.forEach(p=>{
  if(!stats.wins[p]) stats.wins[p]=0;
});

function saveStats(){
  localStorage.setItem("wheelStats", JSON.stringify(stats));
}

function updateStatsUI(){
  let html = `<b>üìä Th·ªëng k√™</b><br><br>`;
  html += `T·ªïng l∆∞·ª£t quay: ${stats.totalSpins}<br><br>`;
  prizes.forEach(p=>{
    html += `${p}: ${stats.wins[p]} l·∫ßn<br>`;
  });
  statsDiv.innerHTML = html;
}
  //////
  
function drawWheel(angle=0){
  const arc = (2*Math.PI)/prizes.length;
  ctx.clearRect(0,0,400,400);

  for(let i=0;i<prizes.length;i++){
    const start = -angle + i*arc;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(centerX,centerY);
    ctx.arc(centerX,centerY,radius,start,end);
    ctx.fillStyle = colors[i%2];
    ctx.fill();
    ctx.closePath();

    ctx.save();
    ctx.translate(centerX,centerY);
    ctx.rotate(start + arc/2);
    ctx.textAlign="right";
    ctx.fillStyle="#fff";
    ctx.font="bold 20px sans-serif";
    ctx.fillText(prizes[i], radius-50, 5);
    ctx.restore();
  }

  // ===== Pointer outside =====
const pointerHeight = 25;
const pointerWidth = 20;

// v·ªã tr√≠ ƒë·ªânh b√°nh xe
const topY = centerY - radius;

ctx.fillStyle = "#ffffff";
ctx.beginPath();

// ƒë·ªânh tam gi√°c ch·∫°m v√†o b√°nh xe
ctx.moveTo(centerX, topY - 2);

// ƒë√°y tam gi√°c n·∫±m ph√≠a tr√™n
ctx.lineTo(centerX - pointerWidth/2, topY - pointerHeight);
ctx.lineTo(centerX + pointerWidth/2, topY - pointerHeight);

ctx.closePath();
ctx.fill();
ctx.strokeStyle = "#f1c40f";
ctx.lineWidth = 3;
ctx.stroke();  
}

drawWheel();
updateStatsUI();    

spinBtn.onclick = function(){
  if(spinning) return;

  spinning = true;
  spinBtn.disabled = true;

  const arc = (2*Math.PI)/prizes.length;

  let availableIndexes = prizes.map((p,i)=>i);

  // N·∫øu ƒë√£ h·∫øt l∆∞·ª£t 500k ‚Üí lo·∫°i kh·ªèi danh s√°ch
  if(stats.wins["500k"] >= max500kWins){
  availableIndexes = availableIndexes.filter(i => prizes[i] !== "500k");
  }

  const targetIndex = availableIndexes[
  Math.floor(Math.random()*availableIndexes.length)
  ];

  // G√≥c gi·ªØa c·ªßa √¥ tr√∫ng (theo h·ªá v·∫Ω)
  const targetAngle = targetIndex * arc + arc/2;

  // M≈©i t√™n ·ªü 12h = -PI/2
  const pointerAngle = -Math.PI/2;

  // V√¨ drawWheel d√πng -angle
  // G√≥c b√°nh xe c·∫ßn c√≥ ƒë·ªÉ target n·∫±m d∆∞·ªõi pointer:
  const absoluteStopAngle = targetAngle - pointerAngle;

  // Th√™m nhi·ªÅu v√≤ng quay ƒë·∫πp
const fullCircle = Math.PI*2;
const spins = fullCircle * 8;

// Chu·∫©n h√≥a g√≥c hi·ªán t·∫°i
const normalizedCurrent = currentAngle % fullCircle;

// T√≠nh ph·∫ßn c·∫ßn b√π ƒë·ªÉ d·ª´ng ƒë√∫ng √¥
let delta = absoluteStopAngle - normalizedCurrent;
if(delta < 0) delta += fullCircle;

const finalAngle = currentAngle + spins + delta;

  animateSpin(currentAngle, finalAngle, 4000, ()=>{
    currentAngle = finalAngle % (Math.PI*2);
 
   const prize = prizes[targetIndex]; 
    
   // ===== C·∫¨P NH·∫¨T TH·ªêNG K√ä =====
        stats.totalSpins++;
    stats.wins[prize]++;

    saveStats();
    updateStatsUI();
    // ==============================
    spinning = false;
    spinBtn.disabled = false;

    alert("üéâ Tr√∫ng: " + prize);
  });
};

function animateSpin(start, end, duration, callback){
  const startTime = performance.now();

  function frame(now){
    const progress = Math.min((now-startTime)/duration,1);
    const ease = 1 - Math.pow(1-progress,4);
    const angle = start + (end-start)*ease;

    drawWheel(angle);

    if(progress<1){
      requestAnimationFrame(frame);
    }else{
      callback();
    }
  }

  requestAnimationFrame(frame);
}
</script>

</body>
</html>
